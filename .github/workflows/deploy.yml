name: Deploy Mailux to Server

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
        
    - name: Build Backend
      run: |
        sudo apt-get update
        sudo apt-get install -y libpam0g-dev build-essential python3
        cd backend
        npm install
        npm run build
        
    - name: Setup Node.js for Frontend
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Build Frontend
      run: |
        cd frontend
        npm install
        npm run build
        
    - name: Deploy to Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Stop existing backend
          echo "ğŸ›‘ Stopping existing backend..."
          if screen -list | grep -q "mailux-backend"; then
            screen -XS "mailux-backend" quit
          fi

          
          sleep 2
          
          echo "ğŸ“ Creating directories..."
          mkdir -p /home/mailserver/backend
          mkdir -p /home/mailserver/frontend
          mkdir -p /home/mailserver/logs
          
          echo "ğŸ§¹ Cleaning old files..."
          rm -rf /home/mailserver/backend/*
          rm -rf /home/mailserver/frontend/*
          
          echo "ğŸ“‹ Copying backend files..."
          mkdir -p /tmp/backend-deploy
          cd /tmp/backend-deploy
          
          
    - name: Copy Backend Files
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "backend/dist/,backend/node_modules/,backend/package.json"
        target: "/home/mailserver/backend"
        strip_components: 1
        
    - name: Copy Frontend Files
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "frontend/dist/"
        target: "/home/mailserver/frontend"
        strip_components: 1

    - name: Set Frontend Permissions
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "ğŸ”§ Setting ownership and permissions for frontend..."
          sudo chown -R www-data:www-data /home/mailserver/frontend
          sudo chmod -R 755 /home/mailserver/frontend
          echo "âœ… Frontend ownership and permissions set"

          # Docker Compose neu starten
          echo "â¹ï¸ Stoppe Frontend-Container..."
          docker-compose -f /root/docker-compose.yml down

          echo "â–¶ï¸ Starte Frontend-Container im Hintergrund..."
          docker-compose -f /root/docker-compose.yml up -d

          echo "âœ… Frontend erfolgreich neu gestartet"

    - name: Prepare Backend
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "ğŸ”§ Preparing backend..."

          # Ins Backend-Verzeichnis wechseln
          cd /home/mailserver/backend || exit 1

          # Alte node_modules lÃ¶schen
          echo "ğŸ—‘ï¸ Deleting old node_modules..."
          rm -rf node_modules

          # AbhÃ¤ngigkeiten neu installieren
          echo "ğŸ“¦ Running npm install..."
          npm install

          # Optional: Berechtigungen fÃ¼r Start-Dateien setzen
          chmod +x dist/index.js

          echo "âœ… Backend is ready"


    - name: Start Backend
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Set permissions
          echo "ğŸ”§ Setting permissions..."
          chmod +x /home/mailserver/backend/dist/index.js
          chmod 755 /home/mailserver/backend
          chmod 755 /home/mailserver/frontend
          
          # Start backend in screen
          echo "ğŸš€ Starting backend in screen session..."
          cd /home/mailserver/backend
          screen -dmS mailux-backend bash -c "echo 'Starting Mailux Backend...' && sudo node dist/index.js > /home/mailserver/logs/backend.log 2>&1 & echo \$! > /home/mailserver/backend.pid && exec bash"
          
          # Wait for backend to start
          sleep 5
          
          # Check if backend is running
          echo "ğŸ” Checking if backend is running..."
          if [ -f /home/mailserver/backend.pid ]; then
            PID=$(cat /home/mailserver/backend.pid)
            if ps -p $PID > /dev/null 2>&1; then
              echo "âœ… Backend is running with PID $PID"
              echo "ğŸ“Š Backend logs: tail -f /home/mailserver/logs/backend.log"
              echo "ğŸ–¥ï¸  Screen session: screen -r mailux-backend"
            else
              echo "âŒ Backend failed to start"
              echo "ğŸ“‹ Check logs: cat /home/mailserver/logs/backend.log"
              exit 1
            fi
          else
            echo "âŒ Backend PID file not found"
            exit 1
          fi
          
          echo "âœ… Deployment completed successfully!"
          echo ""
          echo "ğŸŒ Backend Status:"
          echo "   PID: $PID"
          echo "   Log: /home/mailserver/logs/backend.log"
          echo "   Screen: screen -r mailux-backend"
          echo ""
          echo "ğŸ“ Deployment Paths:"
          echo "   Backend: /home/mailserver/backend"
          echo "   Frontend: /home/mailserver/frontend"